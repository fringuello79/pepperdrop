<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pepper Drop ‚Äì Bocca di Fuoco</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      background: #111;
      color: #f5f5f5;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 10px;
      min-height: 100vh;
    }

    .top-bar {
      width: 480px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .top-bar h1 {
      font-size: 18px;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .title-main {
      color: #ff3b3b; /* rosso fuoco */
    }

    .title-sub {
      font-size: 10px;
      margin-left: 6px;
      color: rgba(255, 255, 255, 0.25); /* appena visibile */
    }

    .logo {
      height: 60px; /* dimensione B, piccola */
    }

    #info {
      font-size: 12px;
      margin-bottom: 8px;
      text-align: left;
      max-width: 480px;
      line-height: 1.4;
    }

    canvas {
      border: 3px solid #555;
      image-rendering: pixelated;
      background: #000;
      touch-action: none; /* per evitare scroll su mobile quando giochi */
    }

    #hud {
      font-size: 12px;
      margin-top: 8px;
      text-align: center;
    }

    .highlight {
      color: #ff4444;
    }

    .buttons {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    #btnStart,
    #btnRestart {
      padding: 4px 10px;
      background: #222;
      border: 1px solid #777;
      color: #f5f5f5;
      cursor: pointer;
      font-family: monospace;
      font-size: 11px;
      text-transform: uppercase;
    }

    #btnStart:hover,
    #btnRestart:hover {
      background: #333;
    }

    /* Controlli mobile grandi in basso ‚Äì sempre visibili */
    .mobile-controls {
      margin-top: 6px;
      width: 480px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .mobile-btn {
      flex: 1;
      padding: 18px 0;                 /* pi√π alti */
      background: linear-gradient(#550000, #220000);
      border: 2px solid #aa0000;
      color: #ff4444;                   /* frecce rosse */
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      user-select: none;
      -webkit-user-select: none;
      border-radius: 10px;              /* angoli arrotondati */
      box-shadow: 0 3px 0 #440000;      /* effetto 3D */
      transition: transform 0.05s, box-shadow 0.05s, background 0.1s;
    }

    .mobile-btn:active {
      background: linear-gradient(#660000, #330000);
      box-shadow: 0 1px 0 #220000;
      transform: translateY(2px);
    }

    #leaderboard {
      margin-top: 10px;
      font-size: 11px;
      width: 480px;
      margin-bottom: 16px;
    }

    #leaderboard h2 {
      font-size: 12px;
      margin: 0 0 4px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #leaderboard ol {
      margin: 0;
      padding-left: 18px;
    }

    #leaderboard li {
      line-height: 1.3;
    }

    /* Primo in classifica evidenziato */
    .lb-first {
      color: #ff4444;
      font-weight: bold;
      font-size: 12px;
    }

    .lb-normal {
      color: #f5f5f5;
      font-weight: normal;
      font-size: 11px;
    }

    #leaderboardNote {
      font-size: 10px;
      margin-top: 4px;
      font-style: italic;
      color: rgba(245, 245, 245, 0.65);
    }

    /* Iconcine sprite peperoncini + latte */
    .icon-pepper {
      display: inline-block;
      width: 12px;
      height: 16px;
      position: relative;
      margin: 0 3px;
      vertical-align: middle;
    }

    .icon-pepper::before,
    .icon-pepper::after {
      content: "";
      position: absolute;
      box-sizing: border-box;
    }

    /* Habanero Red */
    .icon-hab-red::before {
      left: 1px;
      top: 3px;
      width: 10px;
      height: 11px;
      border-radius: 5px 5px 7px 7px;
      background: #d35b5b;
      box-shadow: 0 0 0 1px #5a1111;
    }
    .icon-hab-red::after {
      left: 5px;
      top: 0;
      width: 3px;
      height: 4px;
      background: #4caf50;
      border-radius: 2px;
    }

    /* Habanero Orange */
    .icon-hab-orange::before {
      left: 1px;
      top: 3px;
      width: 10px;
      height: 11px;
      border-radius: 5px 5px 7px 7px;
      background: #ffb144;
      box-shadow: 0 0 0 1px #9a4b10;
    }
    .icon-hab-orange::after {
      left: 5px;
      top: 0;
      width: 3px;
      height: 4px;
      background: #4caf50;
      border-radius: 2px;
    }

    /* Scorpion Yellow */
    .icon-scorpion-yellow::before {
      left: 0px;
      top: 3px;
      width: 11px;
      height: 12px;
      border-radius: 6px 6px 8px 8px;
      background: #f7e45a;
      box-shadow: 0 0 0 1px #7a6420;
    }
    .icon-scorpion-yellow::after {
      left: 5px;
      top: 0;
      width: 3px;
      height: 4px;
      background: #4e9f3d;
      border-radius: 2px;
    }

    /* Habanero Chocolate */
    .icon-hab-choc::before {
      left: 1px;
      top: 3px;
      width: 10px;
      height: 11px;
      border-radius: 5px 5px 7px 7px;
      background: #6b3a17;
      box-shadow: 0 0 0 1px #3b1d0b;
    }
    .icon-hab-choc::after {
      left: 5px;
      top: 0;
      width: 3px;
      height: 4px;
      background: #356b35;
      border-radius: 2px;
    }

    /* Carolina Reaper */
    .icon-reaper::before {
      left: 1px;
      top: 3px;
      width: 10px;
      height: 11px;
      border-radius: 6px 6px 9px 9px;
      background: #5b1414;
      box-shadow: 0 0 0 1px #230202;
    }
    .icon-reaper::after {
      left: 5px;
      top: 0;
      width: 3px;
      height: 4px;
      background: #1b5e20;
      border-radius: 2px;
      box-shadow: 0 4px 0 0 #3a0000; /* codina verso il basso */
    }

    /* Latte */
    .icon-milk {
      display: inline-block;
      width: 10px;
      height: 14px;
      position: relative;
      margin: 0 3px;
      vertical-align: middle;
    }
    .icon-milk::before {
      content: "";
      position: absolute;
      left: 1px;
      top: 2px;
      width: 8px;
      height: 11px;
      background: #ffffff;
      border: 1px solid #bbdefb;
      box-sizing: border-box;
    }
    .icon-milk::after {
      content: "";
      position: absolute;
      left: 2px;
      top: 3px;
      width: 6px;
      height: 3px;
      background: #bbdefb;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>
      <span class="title-main">PEPPER DROP üå∂</span>
      <span class="title-sub">made by PepperAle</span>
    </h1>
    <img class="logo" src="pepperale-logo.png" alt="PepperAle">
  </div>

  <div id="info">
    Muovi l'omino con <span class="highlight">‚Üê ‚Üí</span> o toccando la met√† sinistra/destra dello schermo.<br>
    Mangia i peperoncini buoni = 
    <span class="icon-pepper icon-hab-red"></span> Habanero Red e
    <span class="icon-pepper icon-hab-orange"></span> Habanero Orange: <strong>+1 punto</strong>.<br>
    <span class="icon-pepper icon-scorpion-yellow"></span> Scorpion Yellow: <strong>+2 punti</strong>.<br>
    <span class="icon-pepper icon-hab-choc"></span> Habanero Chocolate: <strong>+3 punti</strong>.<br>
    <span class="icon-pepper icon-reaper"></span> Carolina Reaper: <strong>GAME OVER</strong>.<br>
    Ogni tanto cade anche il <span class="icon-milk"></span> latte: bonus scudo contro il prossimo peperoncino assassino. S√¨, √® codardia liquida, ma va bene.
  </div>

  <canvas id="game" width="480" height="320"></canvas>

  <div id="hud">
    Punteggio: <span id="score">0</span> ‚Äì
    Latte salvavita: <span id="milkCount">0</span><br>
    <span id="status"></span>
  </div>

  <div class="buttons">
    <button id="btnStart">Inizia</button>
    <button id="btnRestart">Ricomincia</button>
  </div>

  <!-- Controlli mobile -->
  <div class="mobile-controls">
    <div id="btnLeft" class="mobile-btn">‚óÄ</div>
    <div id="btnRight" class="mobile-btn">‚ñ∂</div>
  </div>

  <div id="leaderboard">
    <h2>Classifica Orto San Pelino</h2>
    <ol id="leaderboardList"></ol>
    <p id="leaderboardNote">
      Se non sei in lista, probabilmente bevi ancora il latte senza peperoncino.
    </p>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const scoreEl = document.getElementById("score");
    const milkCountEl = document.getElementById("milkCount");
    const statusEl = document.getElementById("status");
    const btnStart = document.getElementById("btnStart");
    const btnRestart = document.getElementById("btnRestart");
    const leaderboardList = document.getElementById("leaderboardList");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    let gameStarted = false;
    let hasPlayedIntro = false;

    const player = {
      x: WIDTH / 2 - 12,
      y: HEIGHT - 52,
      w: 26,
      h: 40,
      speed: 4,
      armPhase: 0,
      moving: false
    };

    let keys = { left: false, right: false };

    let devilStage = 0;
    let prevDevilStage = 0;

    let milkShields = 0;
    let leaderboard = [];

    const objects = [];
    let spawnTimer = 0;
    let spawnInterval = 55;
    let gameOver = false;
    let score = 0;

    let lastDeathByReaper = false;
    let explosionFrame = 0;
    let pendingNamePrompt = false;

    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) {
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          audioCtx = new AudioContext();
        } catch (e) {
          audioCtx = null;
        }
      }
    }

    function playEatSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "square";
      osc.frequency.setValueAtTime(700, now);
      osc.frequency.linearRampToValueAtTime(900, now + 0.08);

      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.12);
    }

    function playEatYellowSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(500, now);
      osc.frequency.linearRampToValueAtTime(650, now + 0.1);

      gain.gain.setValueAtTime(0.25, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.12);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.14);
    }

    function playEatChocolateSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(400, now);
      osc.frequency.linearRampToValueAtTime(550, now + 0.18);

      gain.gain.setValueAtTime(0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.22);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.24);
    }

    function playMilkSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "square";
      osc.frequency.setValueAtTime(523, now);
      osc.frequency.setValueAtTime(659, now + 0.08);
      osc.frequency.setValueAtTime(784, now + 0.16);

      gain.gain.setValueAtTime(0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.35);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.35);
    }

    function playExplosionSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "sawtooth";
      osc.frequency.setValueAtTime(200, now);
      osc.frequency.exponentialRampToValueAtTime(60, now + 0.4);

      gain.gain.setValueAtTime(0.4, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.45);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.5);
    }

    function playStartMusic() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "square";
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.setValueAtTime(587, now + 0.12);
      osc.frequency.setValueAtTime(659, now + 0.24);
      osc.frequency.setValueAtTime(880, now + 0.36);

      gain.gain.setValueAtTime(0.25, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.6);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 0.6);
    }

    function playLevelChangeSound() {
      if (!audioCtx) return;
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "sine";
      osc.frequency.setValueAtTime(220, now);
      osc.frequency.linearRampToValueAtTime(170, now + 0.9);

      gain.gain.setValueAtTime(0.35, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 1.2);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + 1.2);
    }

    window.addEventListener("click", initAudio, { once: true });
    window.addEventListener("keydown", initAudio, { once: true });
    canvas.addEventListener("touchstart", initAudio, { once: true });

    function loadLeaderboard() {
      try {
        const data = localStorage.getItem("pepperDropLeaderboard");
        if (data) {
          leaderboard = JSON.parse(data);
        }
      } catch (e) {
        leaderboard = [];
      }
      renderLeaderboard();
    }

    function saveLeaderboard() {
      try {
        localStorage.setItem("pepperDropLeaderboard", JSON.stringify(leaderboard));
      } catch (e) {}
    }

    function renderLeaderboard() {
      leaderboardList.innerHTML = "";
      leaderboard
        .slice(0, 10)
        .forEach((entry, index) => {
          const li = document.createElement("li");
          if (index === 0) {
            li.className = "lb-first";
          } else {
            li.className = "lb-normal";
          }
          li.textContent = `${entry.name}: ${entry.score}`;
          leaderboardList.appendChild(li);
        });
    }

    function onGameOver() {
      let msgPrompt;
      if (score === 0) {
        msgPrompt = "GAME OVER! Hai preso zero. Vuoi davvero finire in classifica? üò¨";
      } else if (score < 10) {
        msgPrompt = "GAME OVER! Piccantezza da principiante. Inserisci comunque il tuo nome:";
      } else if (score < 30) {
        msgPrompt = "GAME OVER! Niente male, ma le papille sono ancora vive. Nome per la classifica?";
      } else {
        msgPrompt = "GAME OVER! Onorevole rogo. Firma l'impresa:";
      }

      let name = prompt(msgPrompt, "");
      if (name) {
        name = name.trim();
      }
      if (!name) {
        name = "si vergogna di inserire il nome";
      }
      leaderboard.push({ name, score });
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 10);
      saveLeaderboard();
      renderLeaderboard();
    }

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") keys.left = true;
      if (e.key === "ArrowRight") keys.right = true;

      if (gameOver && e.key === " ") {
        if (audioCtx) playStartMusic();
        restartGame();
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft") keys.left = false;
      if (e.key === "ArrowRight") keys.right = false;
    });

    // Touch sul canvas
    function handleTouch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      if (!touch) return;
      const x = touch.clientX - rect.left;

      if (x < WIDTH / 2) {
        keys.left = true;
        keys.right = false;
      } else {
        keys.right = true;
        keys.left = false;
      }
    }

    function endTouch(e) {
      e.preventDefault();
      keys.left = false;
      keys.right = false;
    }

    canvas.addEventListener("touchstart", handleTouch, { passive: false });
    canvas.addEventListener("touchmove", handleTouch, { passive: false });
    canvas.addEventListener("touchend", endTouch, { passive: false });
    canvas.addEventListener("touchcancel", endTouch, { passive: false });

    // Controlli mobile (tasti in basso)
    function pressLeft(e) {
      e.preventDefault();
      keys.left = true;
      keys.right = false;
    }

    function releaseLeft(e) {
      e.preventDefault();
      keys.left = false;
    }

    function pressRight(e) {
      e.preventDefault();
      keys.right = true;
      keys.left = false;
    }

    function releaseRight(e) {
      e.preventDefault();
      keys.right = false;
    }

    if (btnLeft && btnRight) {
      // touch
      btnLeft.addEventListener("touchstart", pressLeft, { passive: false });
      btnLeft.addEventListener("touchend", releaseLeft, { passive: false });
      btnLeft.addEventListener("touchcancel", releaseLeft, { passive: false });

      btnRight.addEventListener("touchstart", pressRight, { passive: false });
      btnRight.addEventListener("touchend", releaseRight, { passive: false });
      btnRight.addEventListener("touchcancel", releaseRight, { passive: false });

      // mouse
      btnLeft.addEventListener("mousedown", pressLeft);
      btnLeft.addEventListener("mouseup", releaseLeft);
      btnLeft.addEventListener("mouseleave", releaseLeft);

      btnRight.addEventListener("mousedown", pressRight);
      btnRight.addEventListener("mouseup", releaseRight);
      btnRight.addEventListener("mouseleave", releaseRight);
    }

    btnRestart.addEventListener("click", () => {
      if (!gameStarted) return;
      if (audioCtx) playStartMusic();
      restartGame();
    });

    btnStart.addEventListener("click", () => {
      initAudio();
      if (!hasPlayedIntro && audioCtx) {
        playStartMusic();
        hasPlayedIntro = true;
      } else if (audioCtx) {
        playStartMusic();
      }
      gameStarted = true;
      btnStart.style.display = "none";
      restartGame();
      // assicuriamoci di vedere bene canvas + tasti
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    function restartGame() {
      score = 0;
      objects.length = 0;
      spawnTimer = 0;
      spawnInterval = 55;
      gameOver = false;
      lastDeathByReaper = false;
      explosionFrame = 0;
      pendingNamePrompt = false;
      player.x = WIDTH / 2 - player.w / 2;
      player.armPhase = 0;
      player.moving = false;
      keys.left = false;
      keys.right = false;
      devilStage = 0;
      prevDevilStage = 0;
      milkShields = 0;
      statusEl.textContent = "";
      updateHUD();
    }

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    function spawnObject() {
      if (score >= 50 && Math.random() < 0.005) {
        const size = 14;
        objects.push({
          x: random(10, WIDTH - 10 - size),
          y: -size,
          w: size,
          h: size * 1.4,
          speedY: random(3.5, 4.5) + score * 0.03,
          type: "milk"
        });
        return;
      }

      const r = Math.random();
      let type;

      if (r < 0.15) {
        type = "habanero";
      } else if (r < 0.30) {
        type = "habanero_orange";
      } else if (r < 0.45) {
        type = "scorpion";
      } else if (r < 0.60) {
        type = "sevenpot";
      } else if (r < 0.74) {
        type = "habanero_choc";
      } else if (r < 0.84) {
        type = "scorpion_yellow";
      } else {
        type = "reaper";
      }

      const size = 14;
      objects.push({
        x: random(10, WIDTH - 10 - size),
        y: -size,
        w: size,
        h: size * 1.6,
        speedY: random(1.8, 2.6) + score * 0.03,
        type: type
      });
    }

    function rectsCollide(a, b) {
      return !(
        a.x + a.w < b.x ||
        a.x > b.x + b.w ||
        a.y + a.h < b.y ||
        a.y > b.y + b.h
      );
    }

    function getLevel() {
      if (score < 5) return 0;
      if (score < 10) return 1;
      if (score < 20) return 2;
      return 3;
    }

    function computeDevilStageFromScore(score) {
      if (score >= 200) return 3;
      if (score >= 100) return 2;
      if (score >= 50) return 1;
      return 0;
    }

    function updateDevilStage() {
      const newStage = computeDevilStageFromScore(score);
      if (newStage > devilStage) {
        prevDevilStage = devilStage;
        devilStage = newStage;
        playLevelChangeSound();
        if (devilStage === 2) {
          statusEl.textContent = "Modalit√† diavoletto attiva üòà ‚Äì complimenti, ora sei tu il problema.";
        } else if (devilStage === 3) {
          statusEl.textContent = "Modalit√† diavolo attiva üëπ ‚Äì non sei ancora all'altezza del Maestro Capsicum.";
        }
      }
    }

    function updateHUD() {
      scoreEl.textContent = score;
      milkCountEl.textContent = milkShields;

      if (!gameOver) {
        if (
          (devilStage === 2 && statusEl.textContent.includes("diavoletto")) ||
          (devilStage === 3 && statusEl.textContent.includes("diavolo"))
        ) {
          return;
        }

        if (score < 5) {
          statusEl.textContent = "Scalda il palato... o torna a mangiare ketchup. üå∂";
        } else if (score < 10) {
          statusEl.textContent = "Comincia a bruciare! Niente che un bambino messicano non farebbe meglio. üî•";
        } else if (score < 20) {
          statusEl.textContent = "Zona Habanero / Scorpion! Adesso s√¨ che piangi con dignit√†. üî•üî•";
        } else if (score < 30) {
          statusEl.textContent = "Seven Pot time üòàüî•üî• ‚Äì ogni punto in pi√π √® un insulto alle papille.";
        } else {
          statusEl.textContent = "Livello Carolina Reaper (ma non mangiarlo!) üöíüî• ‚Äì seriamente, NON fare l‚Äôeroe.";
        }
      }
    }

    function drawBackground() {
      const level = getLevel();
      let baseA, baseB, leafColor;

      if (level === 0) {
        baseA = "#063522";
        baseB = "#0a4228";
        leafColor = "#1b6a38";
      } else if (level === 1) {
        baseA = "#08412a";
        baseB = "#0c5132";
        leafColor = "#207743";
      } else if (level === 2) {
        baseA = "#0a4a2f";
        baseB = "#105b37";
        leafColor = "#2a8c4f";
      } else {
        baseA = "#0b5a36";
        baseB = "#146b3e";
        leafColor = "#34a35b";
      }

      for (let y = 0; y < HEIGHT; y += 16) {
        for (let x = 0; x < WIDTH; x += 16) {
          ctx.fillStyle = (x / 16 + y / 16) % 2 === 0 ? baseA : baseB;
          ctx.fillRect(x, y, 16, 16);

          ctx.fillStyle = leafColor;
          ctx.fillRect(x + 6, y + 4, 2, 8);
          ctx.fillRect(x + 3, y + 6, 3, 3);
          ctx.fillRect(x + 8, y + 6, 3, 3);
        }
      }

      const groundHeight = 40;
      const groundY = HEIGHT - groundHeight;
      for (let y = groundY; y < HEIGHT; y += 8) {
        for (let x = 0; x < WIDTH; x += 8) {
          const toggle = (x / 8 + y / 8) % 2 === 0;
          ctx.fillStyle = toggle ? "#8f877c" : "#7f776d";
          ctx.fillRect(x, y, 8, 8);

          if (toggle) {
            ctx.fillStyle = "#a49c91";
            ctx.fillRect(x + 2, y + 2, 1, 1);
            ctx.fillRect(x + 5, y + 4, 1, 1);
          }
        }
      }

      const boardWidth = 160;
      const boardHeight = 26;
      const boardX = WIDTH / 2 - boardWidth / 2;
      const boardY = 8;

      ctx.fillStyle = "rgba(0,0,0,0.4)";
      ctx.fillRect(boardX + 3, boardY + 4, boardWidth, boardHeight);

      ctx.fillStyle = "#4a2f18";
      ctx.fillRect(boardX, boardY, boardWidth, boardHeight);

      ctx.strokeStyle = "#5c3a20";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(boardX + 8, boardY + 8);
      ctx.lineTo(boardX + boardWidth - 8, boardY + 10);
      ctx.moveTo(boardX + 12, boardY + 18);
      ctx.lineTo(boardX + boardWidth - 12, boardY + 20);
      ctx.stroke();

      ctx.fillStyle = "#d2c5aa";
      const nailSize = 3;
      ctx.fillRect(boardX + 6, boardY + 5, nailSize, nailSize);
      ctx.fillRect(boardX + boardWidth - 9, boardY + 5, nailSize, nailSize);
      ctx.fillRect(boardX + 6, boardY + boardHeight - 8, nailSize, nailSize);
      ctx.fillRect(boardX + boardWidth - 9, boardY + boardHeight - 8, nailSize, nailSize);

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(boardX + 6, boardY + 5, 1, 1);
      ctx.fillRect(boardX + boardWidth - 9, boardY + 5, 1, 1);
      ctx.fillRect(boardX + 6, boardY + boardHeight - 8, 1, 1);
      ctx.fillRect(boardX + boardWidth - 9, boardY + boardHeight - 8, 1, 1);

      const text = "Orto San Pelino";
      ctx.font = "10px monospace";
      const textWidth = ctx.measureText(text).width;
      const textX = boardX + (boardWidth - textWidth) / 2;
      const textY = boardY + 17;

      ctx.fillStyle = "#e5d0b0";
      ctx.globalAlpha = 0.7;
      ctx.fillText(text, textX, textY);
      ctx.globalAlpha = 1.0;
    }

    function drawPlayer() {
      const exploding = gameOver && lastDeathByReaper;

      if (exploding) {
        ctx.save();
        const maxScale = 7;
        const scale = 1 + Math.min(explosionFrame / 10, maxScale - 1);
        const cx = player.x + player.w / 2;
        const cy = player.y + player.h / 2;
        ctx.translate(cx, cy);
        ctx.scale(scale, scale);
        ctx.translate(-cx, -cy);
      }

      const shirtMain  = "#ffffff";
      const shirtShadow = "#d0d0d0";
      const pants      = "#404553";
      const hairMain   = "#4b3726";
      const hairLight  = "#6b4931";

      let skinBase;
      if (devilStage === 0) {
        skinBase = "#fbe2c9";
      } else if (devilStage === 1) {
        skinBase = "#f6bfa5";
      } else if (devilStage === 2) {
        skinBase = "#f08a6a";
      } else {
        skinBase = "#e14b36";
      }

      const amp = 3;
      const offset = Math.sin(player.armPhase) * amp;
      const legOffset = player.moving ? Math.sin(player.armPhase + Math.PI / 2) * 1.5 : 0;

      ctx.fillStyle = "rgba(0,0,0,0.4)";
      ctx.fillRect(player.x + 4, player.y + 38 + legOffset, player.w - 8, 3);

      ctx.fillStyle = pants;
      ctx.fillRect(player.x + 7, player.y + 26 + legOffset, player.w - 14, 8);
      ctx.fillStyle = "#292c37";
      ctx.fillRect(player.x + 6, player.y + 26 + legOffset, 1, 8);
      ctx.fillRect(player.x + player.w - 7, player.y + 26 + legOffset, 1, 8);

      ctx.fillStyle = "#141414";
      ctx.fillRect(player.x + 5, player.y + 34 + legOffset, 8, 3);
      ctx.fillRect(player.x + player.w - 13, player.y + 34 + legOffset, 8, 3);

      ctx.fillStyle = shirtMain;
      ctx.fillRect(player.x + 4, player.y + 14, player.w - 8, 12);
      ctx.fillStyle = shirtShadow;
      ctx.fillRect(player.x + 4, player.y + 22, player.w - 8, 2);

      ctx.fillStyle = skinBase;
      ctx.fillRect(player.x + 9, player.y + 10, 8, 4);

      ctx.fillStyle = skinBase;
      ctx.fillRect(player.x + 4, player.y,     player.w - 8, 4);
      ctx.fillRect(player.x + 3, player.y + 3, player.w - 6, 5);
      ctx.fillRect(player.x + 4, player.y + 8, player.w - 8, 3);

      ctx.fillStyle = "rgba(0,0,0,0.18)";
      ctx.fillRect(player.x + player.w - 5, player.y + 3, 2, 8);

      ctx.fillStyle = "rgba(255,255,255,0.18)";
      ctx.fillRect(player.x + 5, player.y + 1, 4, 2);

      ctx.fillStyle = "rgba(240,140,140,0.5)";
      ctx.fillRect(player.x + 5, player.y + 7, 3, 2);
      ctx.fillRect(player.x + player.w - 8, player.y + 7, 3, 2);

      ctx.fillStyle = "#3b2216";
      ctx.fillRect(player.x + 3, player.y + 3, 1, 6);
      ctx.fillRect(player.x + player.w - 4, player.y + 3, 1, 6);
      ctx.fillRect(player.x + 4, player.y, player.w - 8, 1);

      ctx.fillStyle = hairMain;
      ctx.fillRect(player.x + 3, player.y - 2, player.w - 6, 3);
      ctx.fillRect(player.x + 2, player.y - 1, player.w - 4, 3);
      ctx.fillRect(player.x + 2, player.y - 4, 6, 2);
      ctx.fillRect(player.x + 3, player.y - 5, 4, 1);
      ctx.fillRect(player.x + player.w - 8, player.y - 3, 4, 2);
      ctx.fillStyle = hairLight;
      ctx.fillRect(player.x + 5, player.y - 1, player.w - 12, 1);

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(player.x + 7, player.y + 3, 3, 2);
      ctx.fillRect(player.x + player.w - 10, player.y + 3, 3, 2);

      ctx.fillStyle = (devilStage === 3) ? "#ff0000" : "#000000";
      ctx.fillRect(player.x + 8, player.y + 3, 1, 1);
      ctx.fillRect(player.x + player.w - 9, player.y + 3, 1, 1);

      ctx.fillStyle = "#2b1a10";
      ctx.fillRect(player.x + 7, player.y + 2, 3, 1);
      ctx.fillRect(player.x + player.w - 10, player.y + 2, 3, 1);

      ctx.fillStyle = "#b5775a";
      ctx.fillRect(player.x + player.w / 2 - 1, player.y + 5, 2, 1);

      const mouthWidth = player.w - 12;
      const mouthX = player.x + (player.w - mouthWidth) / 2;

      ctx.fillStyle = "#220000";
      ctx.fillRect(mouthX - 1, player.y + 7, mouthWidth + 2, 8);

      ctx.fillStyle = "#330000";
      ctx.fillRect(mouthX, player.y + 8, mouthWidth, 6);
      ctx.fillStyle = "#550000";
      ctx.fillRect(mouthX, player.y + 8, mouthWidth, 1);

      ctx.fillStyle = "#aa3333";
      ctx.fillRect(mouthX + 2, player.y + 11, mouthWidth - 4, 2);

      if (devilStage >= 2) {
        ctx.fillStyle = devilStage === 2 ? "#f5f5f5" : "#ffeb3b";
        ctx.fillRect(player.x + 5, player.y - 3, 2, 3);
        ctx.fillRect(player.x + 6, player.y - 5, 1, 2);
        ctx.fillRect(player.x + player.w - 7, player.y - 3, 2, 3);
        ctx.fillRect(player.x + player.w - 7, player.y - 5, 1, 2);
      }

      ctx.fillStyle = skinBase;
      ctx.fillRect(player.x - 3, player.y + 16 + offset, 3, 10);
      ctx.fillRect(player.x + player.w, player.y + 16 - offset, 3, 10);

      if (exploding) {
        ctx.fillStyle = "#ffbf00";
        ctx.fillRect(mouthX + mouthWidth, player.y + 9, 8, 5);
        ctx.fillStyle = "#ff6600";
        ctx.fillRect(mouthX + mouthWidth + 8, player.y + 8, 6, 7);

        for (let i = 0; i < 7; i++) {
          const fx = player.x + 1 + i * 4;
          const fy = player.y - 6 - (i % 2) * 3;
          ctx.fillStyle = "#ff6600";
          ctx.fillRect(fx, fy, 4, 4);
          ctx.fillStyle = "#ffd54f";
          ctx.fillRect(fx + 1, fy + 1, 2, 2);
        }
        ctx.restore();
      }
    }

    function drawPepperBase(o, bodyColor, outlineColor, stemColor, variantShapeCallback) {
      ctx.fillStyle = outlineColor;
      variantShapeCallback({
        x: o.x - 1,
        y: o.y - 1,
        w: o.w + 2,
        h: o.h + 2
      });

      ctx.fillStyle = bodyColor;
      variantShapeCallback(o);

      ctx.fillStyle = "rgba(255,255,255,0.15)";
      ctx.fillRect(o.x + 2, o.y + 6, 2, o.h - 10);

      ctx.fillStyle = stemColor;
      ctx.fillRect(o.x + (o.w / 2) - 2, o.y, 4, 6);
    }

    function drawObjects() {
      for (const o of objects) {
        if (o.type === "habanero") {
          drawPepperBase(
            o,
            "#d35b5b",
            "#5a1111",
            "#4caf50",
            (p) => {
              ctx.fillRect(p.x + 3, p.y + 6, p.w - 6, p.h - 8);
            }
          );
        } else if (o.type === "habanero_orange") {
          drawPepperBase(
            o,
            "#ffb144",
            "#9a4b10",
            "#4caf50",
            (p) => {
              ctx.fillRect(p.x + 2, p.y + 6, p.w - 4, p.h - 8);
            }
          );
        } else if (o.type === "scorpion") {
          drawPepperBase(
            o,
            "#c04444",
            "#5a1010",
            "#2e7d32",
            (p) => {
              ctx.fillRect(p.x + 4, p.y + 4, p.w - 8, p.h - 6);
            }
          );
        } else if (o.type === "sevenpot") {
          drawPepperBase(
            o,
            "#d85b4b",
            "#5a1410",
            "#388e3c",
            (p) => {
              ctx.fillRect(p.x + 2, p.y + 6, p.w - 4, p.h - 10);
            }
          );
        } else if (o.type === "habanero_choc") {
          drawPepperBase(
            o,
            "#6b3a17",
            "#3b1d0b",
            "#356b35",
            (p) => {
              ctx.fillRect(p.x + 2, p.y + 6, p.w - 4, p.h - 9);
            }
          );
        } else if (o.type === "scorpion_yellow") {
          drawPepperBase(
            o,
            "#f7e45a",
            "#7a6420",
            "#4e9f3d",
            (p) => {
              ctx.fillRect(p.x + 1, p.y + 6, p.w - 2, p.h - 8);
            }
          );
        } else if (o.type === "reaper") {
          ctx.fillStyle = "#230202";
          ctx.fillRect(o.x + 2, o.y + 4, o.w - 4, o.h - 4);

          ctx.fillStyle = "#5b1414";
          ctx.fillRect(o.x + 3, o.y + 5, o.w - 6, o.h - 6);

          ctx.fillStyle = "#1b5e20";
          ctx.fillRect(o.x + (o.w / 2) - 2, o.y, 4, 6);

          ctx.fillStyle = "#3a0000";
          ctx.fillRect(o.x + o.w / 2 - 2, o.y + o.h, 4, 6);

          ctx.fillStyle = "#f5f5f5";
          ctx.fillRect(o.x + 5, o.y + 8, 6, 5);
          ctx.fillStyle = "#000";
          ctx.fillRect(o.x + 6, o.y + 9, 1, 1);
          ctx.fillRect(o.x + 9, o.y + 9, 1, 1);
        } else if (o.type === "milk") {
          ctx.fillStyle = "#0b345f";
          ctx.fillRect(o.x + 2, o.y + 2, o.w - 4, o.h - 2);
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(o.x + 3, o.y + 4, o.w - 6, o.h - 6);
          ctx.fillStyle = "#bbdefb";
          ctx.fillRect(o.x + 3, o.y + 4, o.w - 6, 3);
        }
      }
    }

    function draw() {
      ctx.save();
      if (gameOver && lastDeathByReaper) {
        const intensity = Math.max(0, 8 - explosionFrame * 0.4);
        const dx = (Math.random() - 0.5) * intensity;
        const dy = (Math.random() - 0.5) * intensity;
        ctx.translate(dx, dy);
      }

      drawBackground();
      drawPlayer();
      drawObjects();

      ctx.fillStyle = "#fff";
      ctx.font = "10px monospace";
      ctx.fillText("PepperAle ‚Äì Seven Pocket 2025", 10, HEIGHT - 10);

      if (gameOver && gameStarted) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(0, HEIGHT / 2 - 20, WIDTH, 40);
        ctx.fillStyle = "#ff4444";
        ctx.font = "14px monospace";
        ctx.fillText("GAME OVER", WIDTH / 2 - 45, HEIGHT / 2 - 2);
        ctx.font = "10px monospace";
        ctx.fillStyle = "#fff";

        let extra;
        if (score === 0) {
          extra = "Hai perso senza nemmeno scaldarti. Notevole.";
        } else if (score < 10) {
          extra = "Piccantezza da turista. Riprova.";
        } else if (score < 30) {
          extra = "Ci stai prendendo gusto. E bruciore.";
        } else {
          extra = "Sei ufficialmente un problema per la gastrite altrui.";
        }

        ctx.fillText(extra, WIDTH / 2 - Math.min(160, extra.length * 3.5), HEIGHT / 2 + 14);
      }

      if (!gameStarted) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(0, HEIGHT / 2 - 15, WIDTH, 30);
        ctx.fillStyle = "#ffffff";
        ctx.font = "12px monospace";
        ctx.fillText("Premi 'Inizia' per cominciare", WIDTH / 2 - 110, HEIGHT / 2 + 4);
      }

      ctx.restore();
    }

    function update() {
      if (!gameStarted) {
        draw();
      } else if (gameOver) {
        if (lastDeathByReaper) {
          explosionFrame++;
          if (pendingNamePrompt && explosionFrame > 25) {
            pendingNamePrompt = false;
            onGameOver();
          }
        }
        draw();
      } else {
        player.moving = false;
        if (keys.left) {
          player.x -= player.speed;
          player.moving = true;
        }
        if (keys.right) {
          player.x += player.speed;
          player.moving = true;
        }
        if (player.x < 5) player.x = 5;
        if (player.x + player.w > WIDTH - 5) player.x = WIDTH - 5 - player.w;

        if (player.moving) {
          player.armPhase += 0.2;
        } else {
          player.armPhase *= 0.8;
        }

        spawnTimer++;
        if (spawnTimer >= spawnInterval) {
          spawnTimer = 0;
          spawnObject();
          if (spawnInterval > 25) {
            spawnInterval -= 0.4;
          }
        }

        for (let i = objects.length - 1; i >= 0; i--) {
          const o = objects[i];
          o.y += o.speedY;

          if (rectsCollide(player, o)) {
            if (o.type === "reaper") {
              if (milkShields > 0) {
                milkShields--;
                statusEl.textContent = "Il latte ti salva dal peperoncino cattivo. Non farci l‚Äôabitudine. ü•õ";
                playMilkSound();
                updateHUD();
                objects.splice(i, 1);
                continue;
              } else {
                gameOver = true;
                lastDeathByReaper = true;
                explosionFrame = 0;
                pendingNamePrompt = true;
                statusEl.textContent = "GAME OVER ‚Äì Maestro Capsicum 1, tu 0. üòµ‚Äçüí´";
                playExplosionSound();
                objects.splice(i, 1);
                continue;
              }
            } else if (o.type === "milk") {
              milkShields++;
              statusEl.textContent = "Hai preso il latte. La tua dignit√† ringrazia in silenzio. ü•õ";
              playMilkSound();
              updateHUD();
              objects.splice(i, 1);
              continue;
            } else {
              if (o.type === "scorpion_yellow") {
                score += 2;
                playEatYellowSound();
              } else if (o.type === "habanero_choc") {
                score += 3;
                playEatChocolateSound();
              } else {
                score += 1;
                playEatSound();
              }
              updateDevilStage();
              updateHUD();
              objects.splice(i, 1);
              continue;
            }
          }

          if (o.y > HEIGHT + 20) {
            objects.splice(i, 1);
          }
        }

        draw();
      }

      requestAnimationFrame(update);
    }

    loadLeaderboard();
    updateHUD();
    update();
  </script>
</body>
</html>
